<!DOCTYPE html>
<html lang="fr">

<head>
    <title>JetKiller Web</title>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0">
    <meta charset="utf-8">
    <link href="../css/main.css" rel="stylesheet">
</head>

<script>
    window.onload = function () {
        const inputCanvas = document.getElementById("input")
        const outputCanvas = document.getElementById("output")

        function onFileSelection() {
            const file = this.files[0];
            const reader = new FileReader()
            reader.addEventListener("error", () => {
                console.log("Erreur à la lecture du fichier, merci de réessayer.", "error")
            });
            reader.addEventListener("load", () => {
                const image = new Image();
                image.src = URL.createObjectURL(file)
                image.addEventListener("load", () => {
                    drawOnCanvas(inputCanvas, image)
                    document.querySelector(".image-input").style.visibility = "visible"
                    document.querySelector(".loading").style.visibility = "visible"
                    outputCanvas.width = inputCanvas.width
                    outputCanvas.height = inputCanvas.height
                    // delay the execution to let the browser redraw and display the loading message
                    setTimeout(() => {
                        const inputContext = inputCanvas.getContext("2d")
                        const inputData = inputContext.getImageData(0, 0, inputContext.canvas.width, inputContext.canvas.height);
                        const outputContext = outputCanvas.getContext("2d")
                        const outputData = transposeImage(inputData)
                        outputContext.putImageData(outputData, 0, 0)
                        document.querySelector(".image-output").style.visibility = "visible"
                        document.querySelector(".loading").style.visibility = "collapse";
                    }, 100)
                });
            });
            reader.readAsArrayBuffer(file);
        }

        const inputElement = document.getElementById("filepicker")
        inputElement.addEventListener("change", onFileSelection)
    };

    function drawOnCanvas(canvas, image) {
        canvas.width = image.width
        canvas.height = image.height
        canvas.getContext("2d").drawImage(image, 0, 0)
    }

    function transposeImage(imageData) {
        const cache = new Map()
        const maxCacheSize = 1024

        function convertPixel(r, g, b) {
            function convertPixelUncached(r, g, b) {
                // Get nearest color from input colormap and return corresponding color in output colormap

                // JET
                const inputMap = [
                    [0., 0., 128.],
                    [0., 0., 130.],
                    [0., 0., 132.],
                    [0., 0., 134.],
                    [0., 0., 137.],
                    [0., 0., 139.],
                    [0., 0., 141.],
                    [0., 0., 143.],
                    [0., 0., 146.],
                    [0., 0., 148.],
                    [0., 0., 150.],
                    [0., 0., 152.],
                    [0., 0., 155.],
                    [0., 0., 157.],
                    [0., 0., 159.],
                    [0., 0., 162.],
                    [0., 0., 164.],
                    [0., 0., 166.],
                    [0., 0., 168.],
                    [0., 0., 171.],
                    [0., 0., 173.],
                    [0., 0., 175.],
                    [0., 0., 177.],
                    [0., 0., 180.],
                    [0., 0., 182.],
                    [0., 0., 184.],
                    [0., 0., 186.],
                    [0., 0., 189.],
                    [0., 0., 191.],
                    [0., 0., 193.],
                    [0., 0., 196.],
                    [0., 0., 198.],
                    [0., 0., 200.],
                    [0., 0., 202.],
                    [0., 0., 205.],
                    [0., 0., 207.],
                    [0., 0., 209.],
                    [0., 0., 211.],
                    [0., 0., 214.],
                    [0., 0., 216.],
                    [0., 0., 218.],
                    [0., 0., 220.],
                    [0., 0., 223.],
                    [0., 0., 225.],
                    [0., 0., 227.],
                    [0., 0., 230.],
                    [0., 0., 232.],
                    [0., 0., 234.],
                    [0., 0., 236.],
                    [0., 0., 239.],
                    [0., 0., 241.],
                    [0., 0., 243.],
                    [0., 0., 245.],
                    [0., 0., 248.],
                    [0., 0., 250.],
                    [0., 0., 252.],
                    [0., 0., 255.],
                    [0., 0., 255.],
                    [0., 0., 255.],
                    [0., 0., 255.],
                    [0., 0., 255.],
                    [0., 0., 255.],
                    [0., 0., 255.],
                    [0., 0., 255.],
                    [0., 0., 255.],
                    [0., 2., 255.],
                    [0., 4., 255.],
                    [0., 6., 255.],
                    [0., 8., 255.],
                    [0., 10., 255.],
                    [0., 12., 255.],
                    [0., 14., 255.],
                    [0., 16., 255.],
                    [0., 18., 255.],
                    [0., 20., 255.],
                    [0., 22., 255.],
                    [0., 24., 255.],
                    [0., 26., 255.],
                    [0., 28., 255.],
                    [0., 30., 255.],
                    [0., 32., 255.],
                    [0., 34., 255.],
                    [0., 36., 255.],
                    [0., 38., 255.],
                    [0., 40., 255.],
                    [0., 42., 255.],
                    [0., 44., 255.],
                    [0., 46., 255.],
                    [0., 48., 255.],
                    [0., 50., 255.],
                    [0., 52., 255.],
                    [0., 54., 255.],
                    [0., 56., 255.],
                    [0., 58., 255.],
                    [0., 60., 255.],
                    [0., 62., 255.],
                    [0., 64., 255.],
                    [0., 66., 255.],
                    [0., 68., 255.],
                    [0., 70., 255.],
                    [0., 72., 255.],
                    [0., 74., 255.],
                    [0., 76., 255.],
                    [0., 78., 255.],
                    [0., 80., 255.],
                    [0., 82., 255.],
                    [0., 84., 255.],
                    [0., 86., 255.],
                    [0., 88., 255.],
                    [0., 90., 255.],
                    [0., 92., 255.],
                    [0., 94., 255.],
                    [0., 96., 255.],
                    [0., 98., 255.],
                    [0., 100., 255.],
                    [0., 102., 255.],
                    [0., 104., 255.],
                    [0., 106., 255.],
                    [0., 108., 255.],
                    [0., 110., 255.],
                    [0., 112., 255.],
                    [0., 114., 255.],
                    [0., 116., 255.],
                    [0., 118., 255.],
                    [0., 120., 255.],
                    [0., 122., 255.],
                    [0., 124., 255.],
                    [0., 126., 255.],
                    [0., 128., 255.],
                    [0., 130., 255.],
                    [0., 132., 255.],
                    [0., 134., 255.],
                    [0., 136., 255.],
                    [0., 138., 255.],
                    [0., 140., 255.],
                    [0., 142., 255.],
                    [0., 144., 255.],
                    [0., 146., 255.],
                    [0., 148., 255.],
                    [0., 150., 255.],
                    [0., 152., 255.],
                    [0., 154., 255.],
                    [0., 156., 255.],
                    [0., 158., 255.],
                    [0., 160., 255.],
                    [0., 162., 255.],
                    [0., 164., 255.],
                    [0., 166., 255.],
                    [0., 168., 255.],
                    [0., 170., 255.],
                    [0., 172., 255.],
                    [0., 174., 255.],
                    [0., 176., 255.],
                    [0., 178., 255.],
                    [0., 180., 255.],
                    [0., 182., 255.],
                    [0., 184., 255.],
                    [0., 186., 255.],
                    [0., 188., 255.],
                    [0., 190., 255.],
                    [0., 192., 255.],
                    [0., 194., 255.],
                    [0., 196., 255.],
                    [0., 198., 255.],
                    [0., 200., 255.],
                    [0., 202., 255.],
                    [0., 204., 255.],
                    [0., 206., 255.],
                    [0., 208., 255.],
                    [0., 210., 255.],
                    [0., 212., 255.],
                    [0., 214., 255.],
                    [0., 216., 255.],
                    [0., 218., 255.],
                    [0., 220., 255.],
                    [0., 222., 253.],
                    [0., 224., 251.],
                    [0., 226., 250.],
                    [0., 228., 248.],
                    [0., 230., 247.],
                    [2., 232., 245.],
                    [3., 234., 243.],
                    [5., 236., 242.],
                    [7., 238., 240.],
                    [8., 240., 238.],
                    [10., 242., 237.],
                    [12., 244., 235.],
                    [13., 246., 234.],
                    [15., 248., 232.],
                    [16., 250., 230.],
                    [18., 252., 229.],
                    [20., 254., 227.],
                    [21., 255., 226.],
                    [23., 255., 224.],
                    [24., 255., 222.],
                    [26., 255., 221.],
                    [28., 255., 219.],
                    [29., 255., 218.],
                    [31., 255., 216.],
                    [32., 255., 214.],
                    [34., 255., 213.],
                    [36., 255., 211.],
                    [37., 255., 210.],
                    [39., 255., 208.],
                    [40., 255., 206.],
                    [42., 255., 205.],
                    [44., 255., 203.],
                    [45., 255., 201.],
                    [47., 255., 200.],
                    [49., 255., 198.],
                    [50., 255., 197.],
                    [52., 255., 195.],
                    [53., 255., 193.],
                    [55., 255., 192.],
                    [57., 255., 190.],
                    [58., 255., 189.],
                    [60., 255., 187.],
                    [61., 255., 185.],
                    [63., 255., 184.],
                    [65., 255., 182.],
                    [66., 255., 181.],
                    [68., 255., 179.],
                    [69., 255., 177.],
                    [71., 255., 176.],
                    [73., 255., 174.],
                    [74., 255., 172.],
                    [76., 255., 171.],
                    [78., 255., 169.],
                    [79., 255., 168.],
                    [81., 255., 166.],
                    [82., 255., 164.],
                    [84., 255., 163.],
                    [86., 255., 161.],
                    [87., 255., 160.],
                    [89., 255., 158.],
                    [90., 255., 156.],
                    [92., 255., 155.],
                    [94., 255., 153.],
                    [95., 255., 152.],
                    [97., 255., 150.],
                    [98., 255., 148.],
                    [100., 255., 147.],
                    [102., 255., 145.],
                    [103., 255., 144.],
                    [105., 255., 142.],
                    [106., 255., 140.],
                    [108., 255., 139.],
                    [110., 255., 137.],
                    [111., 255., 135.],
                    [113., 255., 134.],
                    [115., 255., 132.],
                    [116., 255., 131.],
                    [118., 255., 129.],
                    [119., 255., 127.],
                    [121., 255., 126.],
                    [123., 255., 124.],
                    [124., 255., 123.],
                    [126., 255., 121.],
                    [127., 255., 119.],
                    [129., 255., 118.],
                    [131., 255., 116.],
                    [132., 255., 115.],
                    [134., 255., 113.],
                    [135., 255., 111.],
                    [137., 255., 110.],
                    [139., 255., 108.],
                    [140., 255., 106.],
                    [142., 255., 105.],
                    [144., 255., 103.],
                    [145., 255., 102.],
                    [147., 255., 100.],
                    [148., 255., 98.],
                    [150., 255., 97.],
                    [152., 255., 95.],
                    [153., 255., 94.],
                    [155., 255., 92.],
                    [156., 255., 90.],
                    [158., 255., 89.],
                    [160., 255., 87.],
                    [161., 255., 86.],
                    [163., 255., 84.],
                    [164., 255., 82.],
                    [166., 255., 81.],
                    [168., 255., 79.],
                    [169., 255., 78.],
                    [171., 255., 76.],
                    [172., 255., 74.],
                    [174., 255., 73.],
                    [176., 255., 71.],
                    [177., 255., 69.],
                    [179., 255., 68.],
                    [181., 255., 66.],
                    [182., 255., 65.],
                    [184., 255., 63.],
                    [185., 255., 61.],
                    [187., 255., 60.],
                    [189., 255., 58.],
                    [190., 255., 57.],
                    [192., 255., 55.],
                    [193., 255., 53.],
                    [195., 255., 52.],
                    [197., 255., 50.],
                    [198., 255., 49.],
                    [200., 255., 47.],
                    [201., 255., 45.],
                    [203., 255., 44.],
                    [205., 255., 42.],
                    [206., 255., 40.],
                    [208., 255., 39.],
                    [210., 255., 37.],
                    [211., 255., 36.],
                    [213., 255., 34.],
                    [214., 255., 32.],
                    [216., 255., 31.],
                    [218., 255., 29.],
                    [219., 255., 28.],
                    [221., 255., 26.],
                    [222., 255., 24.],
                    [224., 255., 23.],
                    [226., 255., 21.],
                    [227., 255., 20.],
                    [229., 255., 18.],
                    [230., 255., 16.],
                    [232., 255., 15.],
                    [234., 255., 13.],
                    [235., 255., 12.],
                    [237., 255., 10.],
                    [238., 255., 8.],
                    [240., 253., 7.],
                    [242., 251., 5.],
                    [243., 250., 3.],
                    [245., 248., 2.],
                    [247., 246., 0.],
                    [248., 244., 0.],
                    [250., 242., 0.],
                    [251., 240., 0.],
                    [253., 238., 0.],
                    [255., 237., 0.],
                    [255., 235., 0.],
                    [255., 233., 0.],
                    [255., 231., 0.],
                    [255., 229., 0.],
                    [255., 227., 0.],
                    [255., 226., 0.],
                    [255., 224., 0.],
                    [255., 222., 0.],
                    [255., 220., 0.],
                    [255., 218., 0.],
                    [255., 216., 0.],
                    [255., 214., 0.],
                    [255., 213., 0.],
                    [255., 211., 0.],
                    [255., 209., 0.],
                    [255., 207., 0.],
                    [255., 205., 0.],
                    [255., 203., 0.],
                    [255., 201., 0.],
                    [255., 200., 0.],
                    [255., 198., 0.],
                    [255., 196., 0.],
                    [255., 194., 0.],
                    [255., 192., 0.],
                    [255., 190., 0.],
                    [255., 189., 0.],
                    [255., 187., 0.],
                    [255., 185., 0.],
                    [255., 183., 0.],
                    [255., 181., 0.],
                    [255., 179., 0.],
                    [255., 177., 0.],
                    [255., 176., 0.],
                    [255., 174., 0.],
                    [255., 172., 0.],
                    [255., 170., 0.],
                    [255., 168., 0.],
                    [255., 166., 0.],
                    [255., 165., 0.],
                    [255., 163., 0.],
                    [255., 161., 0.],
                    [255., 159., 0.],
                    [255., 157., 0.],
                    [255., 155., 0.],
                    [255., 153., 0.],
                    [255., 152., 0.],
                    [255., 150., 0.],
                    [255., 148., 0.],
                    [255., 146., 0.],
                    [255., 144., 0.],
                    [255., 142., 0.],
                    [255., 140., 0.],
                    [255., 139., 0.],
                    [255., 137., 0.],
                    [255., 135., 0.],
                    [255., 133., 0.],
                    [255., 131., 0.],
                    [255., 129., 0.],
                    [255., 128., 0.],
                    [255., 126., 0.],
                    [255., 124., 0.],
                    [255., 122., 0.],
                    [255., 120., 0.],
                    [255., 118., 0.],
                    [255., 116., 0.],
                    [255., 115., 0.],
                    [255., 113., 0.],
                    [255., 111., 0.],
                    [255., 109., 0.],
                    [255., 107., 0.],
                    [255., 105., 0.],
                    [255., 104., 0.],
                    [255., 102., 0.],
                    [255., 100., 0.],
                    [255., 98., 0.],
                    [255., 96., 0.],
                    [255., 94., 0.],
                    [255., 92., 0.],
                    [255., 91., 0.],
                    [255., 89., 0.],
                    [255., 87., 0.],
                    [255., 85., 0.],
                    [255., 83., 0.],
                    [255., 81., 0.],
                    [255., 79., 0.],
                    [255., 78., 0.],
                    [255., 76., 0.],
                    [255., 74., 0.],
                    [255., 72., 0.],
                    [255., 70., 0.],
                    [255., 68., 0.],
                    [255., 67., 0.],
                    [255., 65., 0.],
                    [255., 63., 0.],
                    [255., 61., 0.],
                    [255., 59., 0.],
                    [255., 57., 0.],
                    [255., 55., 0.],
                    [255., 54., 0.],
                    [255., 52., 0.],
                    [255., 50., 0.],
                    [255., 48., 0.],
                    [255., 46., 0.],
                    [255., 44., 0.],
                    [255., 43., 0.],
                    [255., 41., 0.],
                    [255., 39., 0.],
                    [255., 37., 0.],
                    [255., 35., 0.],
                    [255., 33., 0.],
                    [255., 31., 0.],
                    [255., 30., 0.],
                    [255., 28., 0.],
                    [255., 26., 0.],
                    [255., 24., 0.],
                    [255., 22., 0.],
                    [255., 20., 0.],
                    [255., 19., 0.],
                    [252., 17., 0.],
                    [250., 15., 0.],
                    [248., 13., 0.],
                    [245., 11., 0.],
                    [243., 9., 0.],
                    [241., 7., 0.],
                    [239., 6., 0.],
                    [236., 4., 0.],
                    [234., 2., 0.],
                    [232., 0., 0.],
                    [230., 0., 0.],
                    [227., 0., 0.],
                    [225., 0., 0.],
                    [223., 0., 0.],
                    [220., 0., 0.],
                    [218., 0., 0.],
                    [216., 0., 0.],
                    [214., 0., 0.],
                    [211., 0., 0.],
                    [209., 0., 0.],
                    [207., 0., 0.],
                    [205., 0., 0.],
                    [202., 0., 0.],
                    [200., 0., 0.],
                    [198., 0., 0.],
                    [196., 0., 0.],
                    [193., 0., 0.],
                    [191., 0., 0.],
                    [189., 0., 0.],
                    [186., 0., 0.],
                    [184., 0., 0.],
                    [182., 0., 0.],
                    [180., 0., 0.],
                    [177., 0., 0.],
                    [175., 0., 0.],
                    [173., 0., 0.],
                    [171., 0., 0.],
                    [168., 0., 0.],
                    [166., 0., 0.],
                    [164., 0., 0.],
                    [162., 0., 0.],
                    [159., 0., 0.],
                    [157., 0., 0.],
                    [155., 0., 0.],
                    [152., 0., 0.],
                    [150., 0., 0.],
                    [148., 0., 0.],
                    [146., 0., 0.],
                    [143., 0., 0.],
                    [141., 0., 0.],
                    [139., 0., 0.],
                    [137., 0., 0.],
                    [134., 0., 0.],
                    [132., 0., 0.],
                    [130., 0., 0.],
                    [128., 0., 0.],
                ]
                // VIRIDIS
                const outputMap = [
                    [68., 1., 84.],
                    [68., 1., 84.],
                    [68., 2., 86.],
                    [68., 2., 86.],
                    [69., 4., 87.],
                    [69., 4., 87.],
                    [69., 5., 89.],
                    [69., 5., 89.],
                    [70., 7., 90.],
                    [70., 7., 90.],
                    [70., 8., 92.],
                    [70., 8., 92.],
                    [70., 10., 93.],
                    [70., 10., 93.],
                    [70., 11., 94.],
                    [70., 11., 94.],
                    [71., 13., 96.],
                    [71., 13., 96.],
                    [71., 14., 97.],
                    [71., 14., 97.],
                    [71., 16., 99.],
                    [71., 16., 99.],
                    [71., 17., 100.],
                    [71., 17., 100.],
                    [71., 19., 101.],
                    [71., 19., 101.],
                    [72., 20., 103.],
                    [72., 20., 103.],
                    [72., 22., 104.],
                    [72., 22., 104.],
                    [72., 23., 105.],
                    [72., 23., 105.],
                    [72., 24., 106.],
                    [72., 24., 106.],
                    [72., 26., 108.],
                    [72., 26., 108.],
                    [72., 27., 109.],
                    [72., 27., 109.],
                    [72., 28., 110.],
                    [72., 28., 110.],
                    [72., 29., 111.],
                    [72., 29., 111.],
                    [72., 31., 112.],
                    [72., 31., 112.],
                    [72., 32., 113.],
                    [72., 32., 113.],
                    [72., 33., 115.],
                    [72., 33., 115.],
                    [72., 35., 116.],
                    [72., 35., 116.],
                    [72., 36., 117.],
                    [72., 36., 117.],
                    [72., 37., 118.],
                    [72., 37., 118.],
                    [72., 38., 119.],
                    [72., 38., 119.],
                    [72., 40., 120.],
                    [72., 40., 120.],
                    [72., 41., 121.],
                    [72., 41., 121.],
                    [71., 42., 122.],
                    [71., 42., 122.],
                    [71., 44., 122.],
                    [71., 44., 122.],
                    [71., 45., 123.],
                    [71., 45., 123.],
                    [71., 46., 124.],
                    [71., 46., 124.],
                    [71., 47., 125.],
                    [71., 47., 125.],
                    [70., 48., 126.],
                    [70., 48., 126.],
                    [70., 50., 126.],
                    [70., 50., 126.],
                    [70., 51., 127.],
                    [70., 51., 127.],
                    [70., 52., 128.],
                    [70., 52., 128.],
                    [69., 53., 129.],
                    [69., 53., 129.],
                    [69., 55., 129.],
                    [69., 55., 129.],
                    [69., 56., 130.],
                    [69., 56., 130.],
                    [68., 57., 131.],
                    [68., 57., 131.],
                    [68., 58., 131.],
                    [68., 58., 131.],
                    [68., 59., 132.],
                    [68., 59., 132.],
                    [67., 61., 132.],
                    [67., 61., 132.],
                    [67., 62., 133.],
                    [67., 62., 133.],
                    [66., 63., 133.],
                    [66., 63., 133.],
                    [66., 64., 134.],
                    [66., 64., 134.],
                    [66., 65., 134.],
                    [66., 65., 134.],
                    [65., 66., 135.],
                    [65., 66., 135.],
                    [65., 68., 135.],
                    [65., 68., 135.],
                    [64., 69., 136.],
                    [64., 69., 136.],
                    [64., 70., 136.],
                    [64., 70., 136.],
                    [63., 71., 136.],
                    [63., 71., 136.],
                    [63., 72., 137.],
                    [63., 72., 137.],
                    [62., 73., 137.],
                    [62., 73., 137.],
                    [62., 74., 137.],
                    [62., 74., 137.],
                    [62., 76., 138.],
                    [62., 76., 138.],
                    [61., 77., 138.],
                    [61., 77., 138.],
                    [61., 78., 138.],
                    [61., 78., 138.],
                    [60., 79., 138.],
                    [60., 79., 138.],
                    [60., 80., 139.],
                    [60., 80., 139.],
                    [59., 81., 139.],
                    [59., 81., 139.],
                    [59., 82., 139.],
                    [59., 82., 139.],
                    [58., 83., 139.],
                    [58., 83., 139.],
                    [58., 84., 140.],
                    [58., 84., 140.],
                    [57., 85., 140.],
                    [57., 85., 140.],
                    [57., 86., 140.],
                    [57., 86., 140.],
                    [56., 88., 140.],
                    [56., 88., 140.],
                    [56., 89., 140.],
                    [56., 89., 140.],
                    [55., 90., 140.],
                    [55., 90., 140.],
                    [55., 91., 141.],
                    [55., 91., 141.],
                    [54., 92., 141.],
                    [54., 92., 141.],
                    [54., 93., 141.],
                    [54., 93., 141.],
                    [53., 94., 141.],
                    [53., 94., 141.],
                    [53., 95., 141.],
                    [53., 95., 141.],
                    [52., 96., 141.],
                    [52., 96., 141.],
                    [52., 97., 141.],
                    [52., 97., 141.],
                    [51., 98., 141.],
                    [51., 98., 141.],
                    [51., 99., 141.],
                    [51., 99., 141.],
                    [50., 100., 142.],
                    [50., 100., 142.],
                    [50., 101., 142.],
                    [50., 101., 142.],
                    [49., 102., 142.],
                    [49., 102., 142.],
                    [49., 103., 142.],
                    [49., 103., 142.],
                    [49., 104., 142.],
                    [49., 104., 142.],
                    [48., 105., 142.],
                    [48., 105., 142.],
                    [48., 106., 142.],
                    [48., 106., 142.],
                    [47., 107., 142.],
                    [47., 107., 142.],
                    [47., 108., 142.],
                    [47., 108., 142.],
                    [46., 109., 142.],
                    [46., 109., 142.],
                    [46., 110., 142.],
                    [46., 110., 142.],
                    [46., 111., 142.],
                    [46., 111., 142.],
                    [45., 112., 142.],
                    [45., 112., 142.],
                    [45., 113., 142.],
                    [45., 113., 142.],
                    [44., 113., 142.],
                    [44., 113., 142.],
                    [44., 114., 142.],
                    [44., 114., 142.],
                    [44., 115., 142.],
                    [44., 115., 142.],
                    [43., 116., 142.],
                    [43., 116., 142.],
                    [43., 117., 142.],
                    [43., 117., 142.],
                    [42., 118., 142.],
                    [42., 118., 142.],
                    [42., 119., 142.],
                    [42., 119., 142.],
                    [42., 120., 142.],
                    [42., 120., 142.],
                    [41., 121., 142.],
                    [41., 121., 142.],
                    [41., 122., 142.],
                    [41., 122., 142.],
                    [41., 123., 142.],
                    [41., 123., 142.],
                    [40., 124., 142.],
                    [40., 124., 142.],
                    [40., 125., 142.],
                    [40., 125., 142.],
                    [39., 126., 142.],
                    [39., 126., 142.],
                    [39., 127., 142.],
                    [39., 127., 142.],
                    [39., 128., 142.],
                    [39., 128., 142.],
                    [38., 129., 142.],
                    [38., 129., 142.],
                    [38., 130., 142.],
                    [38., 130., 142.],
                    [38., 130., 142.],
                    [38., 130., 142.],
                    [37., 131., 142.],
                    [37., 131., 142.],
                    [37., 132., 142.],
                    [37., 132., 142.],
                    [37., 133., 142.],
                    [37., 133., 142.],
                    [36., 134., 142.],
                    [36., 134., 142.],
                    [36., 135., 142.],
                    [36., 135., 142.],
                    [35., 136., 142.],
                    [35., 136., 142.],
                    [35., 137., 142.],
                    [35., 137., 142.],
                    [35., 138., 141.],
                    [35., 138., 141.],
                    [34., 139., 141.],
                    [34., 139., 141.],
                    [34., 140., 141.],
                    [34., 140., 141.],
                    [34., 141., 141.],
                    [34., 141., 141.],
                    [33., 142., 141.],
                    [33., 142., 141.],
                    [33., 143., 141.],
                    [33., 143., 141.],
                    [33., 144., 141.],
                    [33., 144., 141.],
                    [33., 145., 140.],
                    [33., 145., 140.],
                    [32., 146., 140.],
                    [32., 146., 140.],
                    [32., 146., 140.],
                    [32., 146., 140.],
                    [32., 147., 140.],
                    [32., 147., 140.],
                    [31., 148., 140.],
                    [31., 148., 140.],
                    [31., 149., 139.],
                    [31., 149., 139.],
                    [31., 150., 139.],
                    [31., 150., 139.],
                    [31., 151., 139.],
                    [31., 151., 139.],
                    [31., 152., 139.],
                    [31., 152., 139.],
                    [31., 153., 138.],
                    [31., 153., 138.],
                    [31., 154., 138.],
                    [31., 154., 138.],
                    [30., 155., 138.],
                    [30., 155., 138.],
                    [30., 156., 137.],
                    [30., 156., 137.],
                    [30., 157., 137.],
                    [30., 157., 137.],
                    [31., 158., 137.],
                    [31., 158., 137.],
                    [31., 159., 136.],
                    [31., 159., 136.],
                    [31., 160., 136.],
                    [31., 160., 136.],
                    [31., 161., 136.],
                    [31., 161., 136.],
                    [31., 161., 135.],
                    [31., 161., 135.],
                    [31., 162., 135.],
                    [31., 162., 135.],
                    [32., 163., 134.],
                    [32., 163., 134.],
                    [32., 164., 134.],
                    [32., 164., 134.],
                    [33., 165., 133.],
                    [33., 165., 133.],
                    [33., 166., 133.],
                    [33., 166., 133.],
                    [34., 167., 133.],
                    [34., 167., 133.],
                    [34., 168., 132.],
                    [34., 168., 132.],
                    [35., 169., 131.],
                    [35., 169., 131.],
                    [36., 170., 131.],
                    [36., 170., 131.],
                    [37., 171., 130.],
                    [37., 171., 130.],
                    [37., 172., 130.],
                    [37., 172., 130.],
                    [38., 173., 129.],
                    [38., 173., 129.],
                    [39., 173., 129.],
                    [39., 173., 129.],
                    [40., 174., 128.],
                    [40., 174., 128.],
                    [41., 175., 127.],
                    [41., 175., 127.],
                    [42., 176., 127.],
                    [42., 176., 127.],
                    [44., 177., 126.],
                    [44., 177., 126.],
                    [45., 178., 125.],
                    [45., 178., 125.],
                    [46., 179., 124.],
                    [46., 179., 124.],
                    [47., 180., 124.],
                    [47., 180., 124.],
                    [49., 181., 123.],
                    [49., 181., 123.],
                    [50., 182., 122.],
                    [50., 182., 122.],
                    [52., 182., 121.],
                    [52., 182., 121.],
                    [53., 183., 121.],
                    [53., 183., 121.],
                    [55., 184., 120.],
                    [55., 184., 120.],
                    [56., 185., 119.],
                    [56., 185., 119.],
                    [58., 186., 118.],
                    [58., 186., 118.],
                    [59., 187., 117.],
                    [59., 187., 117.],
                    [61., 188., 116.],
                    [61., 188., 116.],
                    [63., 188., 115.],
                    [63., 188., 115.],
                    [64., 189., 114.],
                    [64., 189., 114.],
                    [66., 190., 113.],
                    [66., 190., 113.],
                    [68., 191., 112.],
                    [68., 191., 112.],
                    [70., 192., 111.],
                    [70., 192., 111.],
                    [72., 193., 110.],
                    [72., 193., 110.],
                    [74., 193., 109.],
                    [74., 193., 109.],
                    [76., 194., 108.],
                    [76., 194., 108.],
                    [78., 195., 107.],
                    [78., 195., 107.],
                    [80., 196., 106.],
                    [80., 196., 106.],
                    [82., 197., 105.],
                    [82., 197., 105.],
                    [84., 197., 104.],
                    [84., 197., 104.],
                    [86., 198., 103.],
                    [86., 198., 103.],
                    [88., 199., 101.],
                    [88., 199., 101.],
                    [90., 200., 100.],
                    [90., 200., 100.],
                    [92., 200., 99.],
                    [92., 200., 99.],
                    [94., 201., 98.],
                    [94., 201., 98.],
                    [96., 202., 96.],
                    [96., 202., 96.],
                    [99., 203., 95.],
                    [99., 203., 95.],
                    [101., 203., 94.],
                    [101., 203., 94.],
                    [103., 204., 92.],
                    [103., 204., 92.],
                    [105., 205., 91.],
                    [105., 205., 91.],
                    [108., 205., 90.],
                    [108., 205., 90.],
                    [110., 206., 88.],
                    [110., 206., 88.],
                    [112., 207., 87.],
                    [112., 207., 87.],
                    [115., 208., 86.],
                    [115., 208., 86.],
                    [117., 208., 84.],
                    [117., 208., 84.],
                    [119., 209., 83.],
                    [119., 209., 83.],
                    [122., 209., 81.],
                    [122., 209., 81.],
                    [124., 210., 80.],
                    [124., 210., 80.],
                    [127., 211., 78.],
                    [127., 211., 78.],
                    [129., 211., 77.],
                    [129., 211., 77.],
                    [132., 212., 75.],
                    [132., 212., 75.],
                    [134., 213., 73.],
                    [134., 213., 73.],
                    [137., 213., 72.],
                    [137., 213., 72.],
                    [139., 214., 70.],
                    [139., 214., 70.],
                    [142., 214., 69.],
                    [142., 214., 69.],
                    [144., 215., 67.],
                    [144., 215., 67.],
                    [147., 215., 65.],
                    [147., 215., 65.],
                    [149., 216., 64.],
                    [149., 216., 64.],
                    [152., 216., 62.],
                    [152., 216., 62.],
                    [155., 217., 60.],
                    [155., 217., 60.],
                    [157., 217., 59.],
                    [157., 217., 59.],
                    [160., 218., 57.],
                    [160., 218., 57.],
                    [162., 218., 55.],
                    [162., 218., 55.],
                    [165., 219., 54.],
                    [165., 219., 54.],
                    [168., 219., 52.],
                    [168., 219., 52.],
                    [170., 220., 50.],
                    [170., 220., 50.],
                    [173., 220., 48.],
                    [173., 220., 48.],
                    [176., 221., 47.],
                    [176., 221., 47.],
                    [178., 221., 45.],
                    [178., 221., 45.],
                    [181., 222., 43.],
                    [181., 222., 43.],
                    [184., 222., 41.],
                    [184., 222., 41.],
                    [186., 222., 40.],
                    [186., 222., 40.],
                    [189., 223., 38.],
                    [189., 223., 38.],
                    [192., 223., 37.],
                    [192., 223., 37.],
                    [194., 223., 35.],
                    [194., 223., 35.],
                    [197., 224., 33.],
                    [197., 224., 33.],
                    [200., 224., 32.],
                    [200., 224., 32.],
                    [202., 225., 31.],
                    [202., 225., 31.],
                    [205., 225., 29.],
                    [205., 225., 29.],
                    [208., 225., 28.],
                    [208., 225., 28.],
                    [210., 226., 27.],
                    [210., 226., 27.],
                    [213., 226., 26.],
                    [213., 226., 26.],
                    [216., 226., 25.],
                    [216., 226., 25.],
                    [218., 227., 25.],
                    [218., 227., 25.],
                    [221., 227., 24.],
                    [221., 227., 24.],
                    [223., 227., 24.],
                    [223., 227., 24.],
                    [226., 228., 24.],
                    [226., 228., 24.],
                    [229., 228., 25.],
                    [229., 228., 25.],
                    [231., 228., 25.],
                    [231., 228., 25.],
                    [234., 229., 26.],
                    [234., 229., 26.],
                    [236., 229., 27.],
                    [236., 229., 27.],
                    [239., 229., 28.],
                    [239., 229., 28.],
                    [241., 229., 29.],
                    [241., 229., 29.],
                    [244., 230., 30.],
                    [244., 230., 30.],
                    [246., 230., 32.],
                    [246., 230., 32.],
                    [248., 230., 33.],
                    [248., 230., 33.],
                    [251., 231., 35.],
                    [251., 231., 35.],
                    [253., 231., 37.],
                    [253., 231., 37.],
                ]

                let min = Infinity
                let argMin = -1
                for (const [index, element] of inputMap.entries()) {
                    const [r0, g0, b0] = element
                    const distance = (r - r0) ** 2 + (g - g0) ** 2 + (b - b0) ** 2
                    if (distance < min) {
                        min = distance
                        argMin = index
                    }
                }
                return outputMap[argMin]
            }

            const pixelKey = r + 256 * (g + 256 * b) // Avoid using arrays as keys
            if (cache.has(pixelKey)) {
                return cache.get(pixelKey)
            } else {
                if (cache.size >= maxCacheSize) {
                    cache.delete(cache.keys().next().value) // Delete least recently inserted key
                }
                const result = convertPixelUncached(r, g, b)
                cache.set(pixelKey, result)
                return result
            }
        }

        for (let i = 0; i < imageData.data.length; i += 4) {
            const r0 = imageData.data[i],
                g0 = imageData.data[i + 1],
                b0 = imageData.data[i + 2]

            if (r0 !== g0 || g0 !== b0) { // Grey pixels are not processed
                const [r1, g1, b1] = convertPixel(r0, g0, b0)
                imageData.data[i] = r1
                imageData.data[i + 1] = g1
                imageData.data[i + 2] = b1
            }
        }
        return imageData
    }

</script>

<style>
    .images {
        display: flex;
        flex-wrap: wrap;
    }

    .image-output, .image-input {
        visibility: collapse;
    }

    .loading {
        visibility: collapse;
    }
</style>

<body>
<header>
    <a href="..">Retour vers Jet Killer</a>
</header>
<main>
    <h1>Jet Killer Web</h1>

    <div class="filepicker-block">
        <label for="filepicker">Sélectionner le fichier à convertir</label>
        <input type="file" id="filepicker" name="filepicker" accept="image/*">
    </div>

    <div class="images">
        <div class="image-input">
            <h2>À convertir</h2>
            <canvas id="input"></canvas>
        </div>

        <div class="loading">Patientez pendant la conversion...</div>

        <div class="image-output">
            <h2>Convertie</h2>
            <canvas id="output"></canvas>
        </div>
    </div>
</main>
</body>

</html>
